{% extends "core/base.html" %}
{% load static %}
{% block body_attrs %} data-page="meal-plan" {% endblock %}
{% block title %}Meal Plan{% endblock %}

{% block content %}
<div class="container my-4">

  {# Page header + week navigation — tour anchor #}
  <div class="d-flex justify-content-between align-items-center mb-3" data-tour="meal.header">
    <h2 class="text-body-emphasis mb-0">Meal Plan</h2>
    <div class="d-flex align-items-center gap-2" data-tour="meal.nav">
      {# Previous / Current / Next week controls (your existing links/buttons) #}
      <a class="btn btn-outline-secondary btn-sm" href="?week={{ prev_week|date:'Y-m-d' }}">← Prev</a>
      <a class="btn btn-outline-secondary btn-sm" href="?">This week</a>
      <a class="btn btn-outline-secondary btn-sm" href="?week={{ next_week|date:'Y-m-d' }}">Next →</a>
    </div>
  </div>

  {# Meal plan grid — tour anchor #}
  <div class="table-responsive bg-white rounded-3 shadow-sm p-2" data-tour="meal.table">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th class="text-body-secondary small">Date</th>
          {% for value,label in slots %}
            <th class="text-body-secondary small text-center">{{ label }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr>
            <td class="fw-medium">{{ row.date|date:"D, M j" }}</td>

            {# one cell per slot #}
            {% for cell in row.cells %}
              <td>
                {% if cell.meal %}
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="me-2">
                      <div class="small fw-medium">
                        {{ cell.meal.recipe.title }}
                      </div>
                      <div class="small text-body-secondary">
                        {% if cell.meal.recipe and cell.meal.recipe.calories %}
                          ~{{ cell.meal.recipe.calories }} kcal
                        {% endif %}
                      </div>
                    </div>
                    <form method="post" action="{% url 'core:meal_delete' cell.meal.id %}" class="ms-2">
                      {% csrf_token %}
                      <button class="btn btn-sm btn-outline-danger" title="Remove">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                {% else %}
                  <div class="text-end" data-tour="meal.addform">
                    <form method="post" action="{% url 'core:meal_add' %}" class="d-flex gap-2 align-items-center justify-content-end">
                      {% csrf_token %}
                      <input type="hidden" name="date" value="{{ row.date|date:'Y-m-d' }}">
                      <input type="hidden" name="meal_type" value="{{ cell.slot }}">

                      <select name="recipe_id" class="form-select form-select-sm" style="max-width: 260px;" required>
                        <option value="" selected disabled>Choose from favorites…</option>
                        {% for fav in favorites %}
                          <option value="{{ fav.id }}">{{ fav.title }}</option>
                        {% endfor %}
                      </select>

                      <button class="btn btn-sm btn-primary">Add</button>
                    </form>
                  </div>
                {% endif %}
              </td>
            {% endfor %}

          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Optional small helper — tells users how to link to Targets #}
  <div class="alert alert-secondary small mt-3">
    Tip: Meals you add here for <strong>today</strong> are automatically counted in your
    <a href="{% url 'core:nutrition_target' %}">Targets</a> progress.
  </div>
</div>
{% endblock %}
