{% extends "core/base.html" %}
{% load static %}

{% block title %}{{ recipe.title|default:"Recipe" }} ‚Äî Smart Recipe{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Back link -->
  {% if back_url %}
    <a href="{{ back_url }}" class="btn btn-link p-0">&larr; Back</a>
  {% else %}
    <a href="javascript:history.back()" class="btn btn-link p-0">&larr; Back</a>
  {% endif %}


  <!-- Title -->
  <h2 class="mt-2 text-body-emphasis mb-3">{{ recipe.title|default:"Recipe" }}</h2>

  {# --- Save to favorites --- #}
  <div class="mb-3">
    {% if already_saved %}
      <a href="{% url 'core:favorites' %}" class="btn btn-outline-secondary btn-sm">
        ‚úì In Favorites
      </a>
    {% else %}
      {# Works for both AI and Web recipes #}
      {% if current_id_str %}
        <form method="post"
              action="{% url 'core:save_favorite' source current_id_str %}"
              class="d-inline">
          {% csrf_token %}
          <button class="btn btn-primary btn-sm">
            <i class="bi bi-heart"></i> Save to Favorites
          </button>
        </form>
      {% endif %}

  </div>

  {% endif %}

  <!-- Hero image -->
{% if image_url_final %}
  <img
    src="{{ image_url_final }}"
    alt="{% firstof recipe.title recipe.name current_id_str 'Recipe image' %}"
    class="img-fluid rounded shadow-sm mb-4">
{% endif %}



  <!-- Meta line -->
  <div class="text-body-secondary small mb-4">
    {% if recipe.readyInMinutes %}‚è± {{ recipe.readyInMinutes }} min{% endif %}
    {% if recipe.readyInMinutes and recipe.servings %}&nbsp;¬∑&nbsp;{% endif %}
    {% if recipe.servings %} {{ recipe.servings }} servings{% endif %}
    {% if recipe.sourceUrl %}&nbsp;¬∑&nbsp;<a href="{{ recipe.sourceUrl }}" target="_blank" rel="noopener">Source</a>{% endif %}
  </div>

  <div class="row g-4">
    <!-- LEFT: Ingredients & Instructions -->
    <div class="col-12 col-lg-8">
      <!-- Ingredients -->
      <h3>Ingredients</h3>
      {% if ingredients_list %}
        <ul>
          {% for line in ingredients_list %}
            <li>{{ line }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-body-secondary">No ingredients provided.</p>
      {% endif %}


      <!-- Instructions -->
      <h3>Instructions</h3>
      {% if steps_list %}
        <ol class="mb-3">
          {% for step in steps_list %}
            <li>{{ step }}</li>
          {% endfor %}
        </ol>
      {% else %}
        <p class="text-body-secondary">No instructions provided.</p>
      {% endif %}


      {% if recipe.summary %}
        <div class="mt-4 text-body-secondary small">{{ recipe.summary|safe }}</div>
      {% endif %}
    </div>

    <!-- RIGHT: Nutrition + Log Meal -->
    <div class="col-12 col-lg-4">
      <!-- Nutrition panel (if we have data) -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="card-title mb-2">Nutrition (per serving)</h5>
          {% if recipe.nutrition %}
            <ul class="list-unstyled mb-0 small">
              <li><strong>Calories:</strong> {{ recipe.nutrition.calories|default:0 }} kcal</li>
              <li><strong>Protein:</strong> {{ recipe.nutrition.protein_g|default:0 }} g</li>
              <li><strong>Carbs:</strong> {{ recipe.nutrition.carbs_g|default:0 }} g</li>
              <li><strong>Fat:</strong> {{ recipe.nutrition.fat_g|default:0 }} g</li>
            </ul>
          {% else %}
            <p class="text-body-secondary mb-0 small">No nutrition details available for this recipe.</p>
          {% endif %}
        </div>
      </div>

      <!-- Log Meal form -->
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-2">Log this recipe</h5>
          <p class="text-body-secondary small mb-3">
            Logs to today‚Äôs totals on your Targets page. Quantity multiplies nutrition per serving.
          </p>

          {# ----- Log Meal form ----- #}
          {# Pick the first non-empty ID; fall back to a slugified title. This avoids reverse() errors. #}
          {% firstof recipe.source_id recipe.id recipe.slug recipe.title as rid_raw %}
          {% with rid=rid_raw|slugify %}
            {% if rid %}
              <form method="post"
                    action="{% url 'core:log_recipe_meal' rid %}"
                    class="row g-2 align-items-end">
                {% csrf_token %}

                <!-- Hidden nutrition payload (safe defaults if missing) -->
                <input type="hidden" name="title"     value="{{ recipe.title }}">
                <input type="hidden" name="calories"  value="{{ recipe.nutrition.calories|default:0 }}">
                <input type="hidden" name="protein_g" value="{{ recipe.nutrition.protein_g|default:0 }}">
                <input type="hidden" name="carbs_g"   value="{{ recipe.nutrition.carbs_g|default:0 }}">
                <input type="hidden" name="fat_g"     value="{{ recipe.nutrition.fat_g|default:0 }}">
                <input type="hidden" name="source" value="{{ source }}">
                <input type="hidden" name="key"    value="{{ current_id_str }}">

                <!-- Meal type -->
                <div class="col-6">
                  <label class="form-label small" for="meal_type">Meal</label>
                  <select id="meal_type" name="meal_type" class="form-select form-select-sm" required>
                    <option value="breakfast">Breakfast</option>
                    <option value="lunch" selected>Lunch</option>
                    <option value="dinner">Dinner</option>
                    <option value="snack">Snack</option>
                  </select>
                </div>

                <!-- Quantity multiplier -->
                <div class="col-6">
                  <label class="form-label small" for="quantity">Qty</label>
                  <input id="quantity" name="quantity" type="number" step="0.5" min="0.5" value="1"
                        class="form-control form-control-sm">
                </div>

                <!-- Submit -->
                <div class="col-12">
                  <button class="btn btn-sm btn-primary w-100">Log meal</button>
                </div>
              </form>
            {% else %}
              <!-- Graceful fallback if we truly have no usable ID -->
              <div class="alert alert-warning mb-0">
                We couldn‚Äôt determine a recipe ID to log this meal. You can still cook it üëç‚Äîtry refreshing
                or re-generating to enable logging.
              </div>
            {% endif %}
          {% endwith %}

          <p class="text-body-secondary small mt-2 mb-0" data-tour="targets.quicklog">
            Tip: to change nutrients before logging, use the Quick Log form on the Targets page.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
