{% extends "core/base.html" %}
{% load static %}
{% block body_attrs %} data-page="targets" {% endblock %}

{% block title %}Nutrition Targets{% endblock %}

{% block content %}
<div class="container py-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-3">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-body-emphasis mb-0">Nutrition Targets</h2>
    <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary">← Back to Dashboard</a>
  </div>

  <div class="row g-4">
    <!-- LEFT: Target settings -->
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm" data-tour="targets.form">
        <div class="card-body">
          <h5 class="card-title mb-3">Set Your Daily Targets</h5>

          <form method="post" action="{% url 'core:nutrition_target' %}">
            {% csrf_token %}

            <div class="mb-2">
              <label for="calories" class="form-label">
                Calories (kcal)
                <span class="text-body-secondary" data-bs-toggle="tooltip" title="Total energy per day.">ⓘ</span>
              </label>
              <input type="number" min="0" class="form-control" id="calories" name="calories"
                     value="{{ target.calories|default_if_none:'' }}" placeholder="2000" required>
              <div class="form-text">How much energy you aim to consume each day.</div>
            </div>

            <div class="row g-3">
              <div class="col-4">
                <label for="protein_g" class="form-label">
                  Protein (g)
                  <span class="text-body-secondary" data-bs-toggle="tooltip" title="Daily protein target.">ⓘ</span>
                </label>
                <input type="number" min="0" class="form-control" id="protein_g" name="protein_g"
                       value="{{ target.protein_g|default_if_none:'' }}" placeholder="140">
              </div>
              <div class="col-4">
                <label for="carbs_g" class="form-label">
                  Carbs (g)
                  <span class="text-body-secondary" data-bs-toggle="tooltip" title="Daily carbohydrates.">ⓘ</span>
                </label>
                <input type="number" min="0" class="form-control" id="carbs_g" name="carbs_g"
                       value="{{ target.carbs_g|default_if_none:'' }}" placeholder="200">
              </div>
              <div class="col-4">
                <label for="fat_g" class="form-label">
                  Fat (g)
                  <span class="text-body-secondary" data-bs-toggle="tooltip" title="Daily fats.">ⓘ</span>
                </label>
                <input type="number" min="0" class="form-control" id="fat_g" name="fat_g"
                       value="{{ target.fat_g|default_if_none:'' }}" placeholder="70">
              </div>
            </div>

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-primary">Save Targets</button>
              <a href="{% url 'core:nutrition_target_reset' %}" class="btn btn-outline-danger">Reset</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- RIGHT: Progress & suggestions -->
    <div class="col-12 col-lg-7">

      <div class="alert alert-secondary small mb-3">
        <strong>How this works:</strong>
        Save your daily targets on the left. As you log meals, we calculate today’s calories and macros here.
        Not logging meals yet? Start from any recipe → “Log meal”.
      </div>

      {# Quick log — tour anchor #}
      <div class="card shadow-sm mb-4" id="quick-log" data-tour="targets.quicklog">
        <div class="card-body">
          <h6 class="card-title mb-2">Quick log</h6>
          <form method="post" action="{% url 'core:log_custom_meal' %}" class="row g-2 align-items-end">
            {% csrf_token %}
            <div class="col-12 col-md-4">
              <label class="form-label small" for="ql_title">Title</label>
              <input id="ql_title" name="title" class="form-control form-control-sm" placeholder="e.g., Chicken bowl">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="ql_cal">Calories</label>
              <input id="ql_cal" name="calories" type="number" min="0" class="form-control form-control-sm" placeholder="500">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="ql_p">Protein (g)</label>
              <input id="ql_p" name="protein_g" type="number" min="0" class="form-control form-control-sm" placeholder="30">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="ql_c">Carbs (g)</label>
              <input id="ql_c" name="carbs_g" type="number" min="0" class="form-control form-control-sm" placeholder="40">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="ql_f">Fat (g)</label>
              <input id="ql_f" name="fat_g" type="number" min="0" class="form-control form-control-sm" placeholder="15">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small" for="ql_type">Meal</label>
              <select id="ql_type" name="meal_type" class="form-select form-select-sm">
                <option value="breakfast">Breakfast</option>
                <option value="lunch" selected>Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="snack">Snack</option>
              </select>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="ql_qty">Qty</label>
              <input id="ql_qty" name="quantity" type="number" min="0" step="any" value="1" class="form-control form-control-sm">
            </div>
            <div class="col-12 col-md-3">
              <button class="btn btn-sm btn-primary w-100">Log meal</button>
            </div>
          </form>
          <p class="text-body-secondary small mt-2 mb-0">Tip: Use this for anything not from a saved recipe.</p>
        </div>
      </div>

      {# Progress — tour anchor #}
      <div class="card shadow-sm mb-4" data-tour="targets.progress">
        <div class="card-body">
          <h5 class="card-title mb-2">Today’s Progress</h5>

          {% if target and totals %}
            <div class="mb-3">
              <div class="d-flex justify-content-between">
                <span>Calories</span>
                <span>{{ totals.calories|default:0 }} / {{ target.calories|default:"—" }} kcal</span>
              </div>
              <div class="progress" role="progressbar"
                   aria-label="Calories progress"
                   aria-valuenow="{{ totals.calories_pct|default:0 }}" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar {% if totals.calories_pct > 110 %}bg-danger{% elif totals.calories_pct > 100 %}bg-warning{% endif %}"
                     style="width: {{ totals.calories_pct|default:0 }}%"></div>
              </div>
              {% if totals.calories|default:0 == 0 %}
                <p class="text-body-secondary small mb-0 mt-1">No meals logged today yet. Log your first meal to see progress.</p>
              {% endif %}
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-4">
                <div class="small d-flex justify-content-between mb-1">
                  <span>Protein</span>
                  <span>{{ totals.protein_g|default:0 }} / {{ target.protein_g|default:"—" }} g</span>
                </div>
                <div class="progress" role="progressbar" aria-label="Protein progress"
                     aria-valuenow="{{ totals.protein_pct|default:0 }}" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar" style="width: {{ totals.protein_pct|default:0 }}%"></div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="small d-flex justify-content-between mb-1">
                  <span>Carbs</span>
                  <span>{{ totals.carbs_g|default:0 }} / {{ target.carbs_g|default:"—" }} g</span>
                </div>
                <div class="progress" role="progressbar" aria-label="Carbs progress"
                     aria-valuenow="{{ totals.carbs_pct|default:0 }}" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar" style="width: {{ totals.carbs_pct|default:0 }}%"></div>
                </div>
              </div>
              <div class="col-12 col-md-4">
                <div class="small d-flex justify-content-between mb-1">
                  <span>Fat</span>
                  <span>{{ totals.fat_g|default:0 }} / {{ target.fat_g|default:"—" }} g</span>
                </div>
                <div class="progress" role="progressbar" aria-label="Fat progress"
                     aria-valuenow="{{ totals.fat_pct|default:0 }}" aria-valuemin="0" aria-valuemax="100">
                  <div class="progress-bar" style="width: {{ totals.fat_pct|default:0 }}%"></div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <canvas id="macrosChart" height="200" aria-label="Macronutrient breakdown" role="img"></canvas>
            </div>

            <script id="macros-data" type="application/json">
              {
                "protein": {{ totals.protein_g|default:0 }},
                "carbs":   {{ totals.carbs_g|default:0 }},
                "fat":     {{ totals.fat_g|default:0 }}
              }
            </script>
          {% else %}
            <div class="alert alert-info mt-2">
              Set your daily targets on the left to start tracking calories and macros.
            </div>
          {% endif %}
        </div>
      </div>

      {% if todays_meals %}
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h6 class="card-title mb-2">Today’s meals</h6>
            <ul class="list-group list-group-flush">
              {% for m in todays_meals %}
                <!-- ------------------------------
                   Show the recipe title if we have it (planned meal),
                   otherwise fall back to whatever was logged.
                   ------------------------------ -->
                {% with meal_title=m.recipe.title|default:m.title %}
                <li class="list-group-item">
                  <div class="d-flex justify-content-between align-items-start gap-3">
                    <div>
                      <strong class="me-2">{{ meal_title }}</strong>
                      <span class="text-body-secondary small">{{ m.meal_type|capfirst }}</span>

                      <div class="small text-body-secondary">
                        {{ m.calories }} kcal · P {{ m.protein_g }}g · C {{ m.carbs_g }}g · F {{ m.fat_g }}g
                        {% if m.recipe %}<span class="ms-2 badge text-bg-light">Planned</span>{% endif %}
                      </div>
                    </div>

                    <div class="d-flex gap-2">
                      {# Toggle the inline editor (Bootstrap collapse) #}
                      <a class="btn btn-sm btn-outline-secondary"
                         data-bs-toggle="collapse" href="#edit-{{ m.id }}" role="button"
                         aria-expanded="false" aria-controls="edit-{{ m.id }}">Edit</a>

                      <form method="post" action="{% url 'core:delete_meal' m.id %}">
                        {% csrf_token %}
                        <button class="btn btn-sm btn-outline-danger">Remove</button>
                      </form>
                    </div>
                  </div>

                   <!-- -------------------------------------------
                     Inline EDIT form (prefilled). We prefill from
                     the SavedRecipe (m.recipe) when present; if not,
                     we fall back to the LoggedMeal values.
                     -------------------------------------------  -->
                  <div class="collapse mt-3" id="edit-{{ m.id }}">
                    <form method="post" action="{% url 'core:update_logged_meal' m.id %}">
                      {% csrf_token %}
                      <div class="row g-2 align-items-end">
                        <div class="col-12 col-md-4">
                          <label class="form-label small">Title</label>
                          <input name="title" class="form-control form-control-sm"
                                 value="{{ meal_title }}">
                        </div>

                        <div class="col-6 col-md-2">
                          <label class="form-label small">Calories</label>
                          <input type="number" min="0" step="1" name="calories"
                                 class="form-control form-control-sm"
                                 value="{{ m.recipe.calories|default:m.calories|default:0 }}">
                        </div>
                        <div class="col-6 col-md-2">
                          <label class="form-label small">Protein (g)</label>
                          <input type="number" min="0" step="0.1" name="protein_g"
                                 class="form-control form-control-sm"
                                 value="{{ m.recipe.protein_g|default:m.protein_g|default:0 }}">
                        </div>
                        <div class="col-6 col-md-2">
                          <label class="form-label small">Carbs (g)</label>
                          <input type="number" min="0" step="0.1" name="carbs_g"
                                 class="form-control form-control-sm"
                                 value="{{ m.recipe.carbs_g|default:m.carbs_g|default:0 }}">
                        </div>
                        <div class="col-6 col-md-2">
                          <label class="form-label small">Fat (g)</label>
                          <input type="number" min="0" step="0.1" name="fat_g"
                                 class="form-control form-control-sm"
                                 value="{{ m.recipe.fat_g|default:m.fat_g|default:0 }}">
                        </div>

                        <div class="col-12 d-flex gap-2">
                          <button class="btn btn-sm btn-primary">Save</button>
                          <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#edit-{{ m.id }}">Cancel</a>
                        </div>
                      </div>
                    </form>
                  </div>
                </li>
                {% endwith %}
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}

      {# Suggestions — tour anchor #}
      <div class="card shadow-sm" data-tour="targets.suggestions">
        <div class="card-body">
          <h5 class="card-title mb-3">Recipe Suggestions</h5>
          {% if suggestions %}
            <div class="row g-3">
              {% for r in suggestions %}
                <div class="col-12 col-md-6">
                  <div class="border rounded p-3 h-100">
                    <div class="d-flex align-items-start gap-3">
                      {% if r.image %}<img src="{{ r.image }}" class="rounded" alt="{{ r.title }}" width="72" height="72" style="object-fit: cover;">{% endif %}
                      <div>
                        <h6 class="mb-1">{{ r.title }}</h6>
                        <div class="small text-body-secondary">
                          {% if r.protein_g %}Protein: {{ r.protein_g }}g · {% endif %}
                          {% if r.calories %}~{{ r.calories }} kcal{% endif %}
                        </div>
                        {# Link to recipe detail (expects session to contain the same 'web' item) #}
                        <a href="{% url 'core:recipe_detail' 'web' r.id %}" class="btn btn-sm btn-outline-primary mt-2">View</a>
                        {# Shortcut back to recipe area (your existing behavior) #}
                        <a href="{% url 'core:dashboard' %}#recipes" class="btn btn-sm btn-primary mt-2">Log meal</a>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-body-secondary mb-0">No suggestions yet. Save targets and log meals to unlock tailored ideas.</p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script src="{% static 'core/js/nutrition_target.js' %}"></script>
{% endblock %}
